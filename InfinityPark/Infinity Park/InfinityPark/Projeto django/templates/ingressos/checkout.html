{% extends 'base.html' %}

{% block title %}Checkout - Infinity Park{% endblock %}

{% block content %}
<div class="container py-4">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'paginas:home' %}">Home</a></li>
            <li class="breadcrumb-item"><a href="{% url 'ingressos:lista' %}">Ingressos</a></li>
            <li class="breadcrumb-item"><a href="{% url 'ingressos:carrinho' %}">Carrinho</a></li>
            <li class="breadcrumb-item active" aria-current="page">Checkout</li>
        </ol>
    </nav>
    
    <div class="row">
        <div class="col-12 text-center mb-4">
            <h1 class="display-4 fw-bold">
                <i class="fas fa-credit-card text-primary"></i>
                Finalizar Compra
            </h1>
        </div>
    </div>
    
    <div class="row">
        <!-- Formulário de Pagamento -->
        <div class="col-md-8">
            <div class="card shadow mb-4">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">Informações de Pagamento</h4>
                </div>
                <div class="card-body">
                    <form id="form-pagamento" method="post" action="{% url 'ingressos:processar_pagamento' %}">
                        {% csrf_token %}
                        
                        <!-- Dados Pessoais -->
                        <h5 class="mb-3">Dados Pessoais</h5>
                        <div class="row mb-4">
                            <div class="col-md-6 mb-3">
                                <label for="nome" class="form-label">Nome Completo</label>
                                <input type="text" class="form-control" id="nome" name="nome" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="email" class="form-label">Email</label>
                                <input type="email" class="form-control" id="email" name="email" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="cpf" class="form-label">CPF</label>
                                <input type="text" class="form-control" id="cpf" name="cpf" placeholder="000.000.000-00" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="telefone" class="form-label">Telefone</label>
                                <input type="tel" class="form-control" id="telefone" name="telefone" placeholder="(00) 00000-0000" required>
                            </div>
                        </div>
                        
                        <!-- Data da Visita -->
                        <h5 class="mb-3">Data da Visita</h5>
                        <div class="row mb-4">
                            <div class="col-md-6 mb-3">
                                <label for="data_visita" class="form-label">Data de Visita</label>
                                <input type="date" class="form-control" id="data_visita" name="data_visita" required>
                            </div>
                        </div>
                        
                        <!-- Método de Pagamento -->
                        <h5 class="mb-3">Método de Pagamento</h5>
                        <div class="row mb-4">
                            <div class="col-12 mb-3">
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="metodo_pagamento" id="cartao_credito" value="cartao_credito" checked>
                                    <label class="form-check-label" for="cartao_credito">
                                        <i class="fas fa-credit-card me-2"></i> Cartão de Crédito
                                    </label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="metodo_pagamento" id="cartao_debito" value="cartao_debito">
                                    <label class="form-check-label" for="cartao_debito">
                                        <i class="fas fa-credit-card me-2"></i> Cartão de Débito
                                    </label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="metodo_pagamento" id="pix" value="pix">
                                    <label class="form-check-label" for="pix">
                                        <i class="fas fa-qrcode me-2"></i> PIX
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Dados do Cartão -->
                        <div id="dados-cartao">
                            <h5 class="mb-3">Dados do Cartão</h5>
                            <div class="row mb-4">
                                <div class="col-md-6 mb-3">
                                    <label for="numero_cartao" class="form-label">Número do Cartão</label>
                                    <input type="text" class="form-control" id="numero_cartao" name="numero_cartao" placeholder="0000 0000 0000 0000">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="nome_cartao" class="form-label">Nome no Cartão</label>
                                    <input type="text" class="form-control" id="nome_cartao" name="nome_cartao">
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="validade" class="form-label">Validade</label>
                                    <input type="text" class="form-control" id="validade" name="validade" placeholder="MM/AA">
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="cvv" class="form-label">CVV</label>
                                    <input type="text" class="form-control" id="cvv" name="cvv" placeholder="000">
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="parcelas" class="form-label">Parcelas</label>
                                    <select class="form-select" id="parcelas" name="parcelas">
                                        <option value="1">1x de R$ {{ total }} (sem juros)</option>
                                        <option value="2">2x de R$ {{ total_parcelado.2 }}</option>
                                        <option value="3">3x de R$ {{ total_parcelado.3 }}</option>
                                        <option value="4">4x de R$ {{ total_parcelado.4 }}</option>
                                        <option value="5">5x de R$ {{ total_parcelado.5 }}</option>
                                        <option value="6">6x de R$ {{ total_parcelado.6 }}</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Dados do PIX -->
                        <div id="dados-pix" style="display: none;">
                            <div class="row mb-4">
                                <div class="col-12 text-center">
                                    <p class="mb-3">Escaneie o QR Code abaixo ou copie a chave PIX para realizar o pagamento:</p>
                                    <div class="mb-3">
                                        <img src="{% static 'img/qrcode-pix.png' %}" alt="QR Code PIX" class="img-fluid" style="max-width: 200px;">
                                    </div>
                                    <div class="input-group mb-3 w-75 mx-auto">
                                        <input type="text" class="form-control" value="00020126580014br.gov.bcb.pix0136a1f86a02-9c3b-4d34-8b44-7bcd1ac3d5c40217Infinity Park Ingressos5204000053039865802BR5923INFINITY PARK DIVERSOES6009SAO PAULO62070503***63041D57" readonly>
                                        <button class="btn btn-outline-primary" type="button" id="btn-copiar-pix">
                                            <i class="fas fa-copy"></i> Copiar
                                        </button>
                                    </div>
                                    <p class="text-muted small">O pagamento será confirmado automaticamente em até 5 minutos após a transferência.</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Termos e Condições -->
                        <div class="form-check mb-4">
                            <input class="form-check-input" type="checkbox" id="termos" name="termos" required>
                            <label class="form-check-label" for="termos">
                                Li e concordo com os <a href="#" data-bs-toggle="modal" data-bs-target="#termos-modal">Termos e Condições</a> e <a href="#" data-bs-toggle="modal" data-bs-target="#politica-modal">Política de Privacidade</a>
                            </label>
                        </div>
                        
                        <!-- Botões -->
                        <div class="d-flex justify-content-between">
                            <a href="{% url 'ingressos:carrinho' %}" class="btn btn-outline-primary">
                                <i class="fas fa-arrow-left me-2"></i> Voltar para o Carrinho
                            </a>
                            <button type="submit" class="btn btn-success btn-lg">
                                <i class="fas fa-lock me-2"></i> Finalizar Pagamento
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- Resumo da Compra -->
        <div class="col-md-4">
            <div class="card shadow sticky-top" style="top: 20px;">
                <div class="card-header bg-success text-white">
                    <h4 class="mb-0">Resumo da Compra</h4>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <h5 class="mb-3">Itens</h5>
                        {% for item in items_carrinho %}
                        <div class="d-flex justify-content-between mb-2">
                            <span>{{ item.tipo_ingresso.nome }} x {{ item.quantidade }}</span>
                            <span>R$ {{ item.total }}</span>
                        </div>
                        {% endfor %}
                    </div>
                    
                    <hr>
                    
                    <div class="d-flex justify-content-between mb-2">
                        <span>Subtotal:</span>
                        <span>R$ {{ subtotal }}</span>
                    </div>
                    
                    {% if desconto %}
                    <div class="d-flex justify-content-between mb-2">
                        <span>Desconto:</span>
                        <span class="text-danger">- R$ {{ desconto }}</span>
                    </div>
                    {% endif %}
                    
                    <div class="d-flex justify-content-between mb-2">
                        <span>Taxa de serviço:</span>
                        <span>R$ {{ taxa_servico }}</span>
                    </div>
                    
                    <hr>
                    
                    <div class="d-flex justify-content-between mb-0">
                        <span class="h5">Total:</span>
                        <span class="h5 text-primary">R$ {{ total }}</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Termos e Condições -->
<div class="modal fade" id="termos-modal" tabindex="-1" aria-labelledby="termos-modal-label" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="termos-modal-label">Termos e Condições</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <h5>1. Condições Gerais</h5>
                <p>Ao adquirir ingressos para o Infinity Park, você concorda com todos os termos e condições aqui estabelecidos. Os ingressos são válidos apenas para a data especificada no momento da compra.</p>
                
                <h5>2. Política de Cancelamento</h5>
                <p>Cancelamentos podem ser realizados com até 7 dias de antecedência da data da visita, com reembolso de 80% do valor pago. Após esse período, não haverá reembolso.</p>
                
                <h5>3. Alteração de Data</h5>
                <p>A alteração da data de visita pode ser realizada com até 48 horas de antecedência, sujeita à disponibilidade e mediante taxa administrativa de R$ 10,00 por ingresso.</p>
                
                <h5>4. Regras do Parque</h5>
                <p>É obrigatório seguir todas as regras de segurança do parque. O não cumprimento pode resultar na retirada do visitante sem direito a reembolso.</p>
                
                <h5>5. Responsabilidade</h5>
                <p>O Infinity Park não se responsabiliza por objetos perdidos ou danificados durante a visita, nem por acidentes decorrentes do descumprimento das normas de segurança.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Entendi</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Política de Privacidade -->
<div class="modal fade" id="politica-modal" tabindex="-1" aria-labelledby="politica-modal-label" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="politica-modal-label">Política de Privacidade</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <h5>1. Coleta de Dados</h5>
                <p>Coletamos informações pessoais como nome, e-mail, CPF e telefone para processamento de compras e identificação de visitantes.</p>
                
                <h5>2. Uso de Dados</h5>
                <p>As informações coletadas são utilizadas para processamento de pagamentos, emissão de ingressos, comunicação sobre sua compra e envio de informações relevantes sobre sua visita.</p>
                
                <h5>3. Compartilhamento de Dados</h5>
                <p>Seus dados podem ser compartilhados com parceiros de processamento de pagamento e serviços relacionados à sua visita, sempre respeitando a confidencialidade e segurança.</p>
                
                <h5>4. Armazenamento</h5>
                <p>Seus dados são armazenados em servidores seguros e protegidos por medidas técnicas adequadas para garantir sua privacidade.</p>
                
                <h5>5. Seus Direitos</h5>
                <p>Você tem direito a acessar, corrigir e solicitar a exclusão de seus dados, conforme previsto na Lei Geral de Proteção de Dados (LGPD).</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Entendi</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Alternar entre métodos de pagamento
        const metodoPagamento = document.querySelectorAll('input[name="metodo_pagamento"]');
        const dadosCartao = document.getElementById('dados-cartao');
        const dadosPix = document.getElementById('dados-pix');
        
        metodoPagamento.forEach(metodo => {
            metodo.addEventListener('change', function() {
                if (this.value === 'pix') {
                    dadosCartao.style.display = 'none';
                    dadosPix.style.display = 'block';
                } else {
                    dadosCartao.style.display = 'block';
                    dadosPix.style.display = 'none';
                }
            });
        });
        
        // Copiar código PIX
        const btnCopiarPix = document.getElementById('btn-copiar-pix');
        if (btnCopiarPix) {
            btnCopiarPix.addEventListener('click', function() {
                const codigoPix = this.previousElementSibling;
                codigoPix.select();
                document.execCommand('copy');
                alert('Código PIX copiado!');
            });
        }
        
        // Validação do formulário
        const formPagamento = document.getElementById('form-pagamento');
        formPagamento.addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Simulação de processamento de pagamento
            const btnSubmit = this.querySelector('button[type="submit"]');
            btnSubmit.disabled = true;
            btnSubmit.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i> Processando...';
            
            setTimeout(function() {
                window.location.href = '{% url "ingressos:compra_sucesso" %}';
            }, 3000);
        });
        
        // Máscaras para campos
        if (typeof IMask !== 'undefined') {
            // CPF
            IMask(document.getElementById('cpf'), {
                mask: '000.000.000-00'
            });
            
            // Telefone
            IMask(document.getElementById('telefone'), {
                mask: '(00) 00000-0000'
            });
            
            // Cartão
            IMask(document.getElementById('numero_cartao'), {
                mask: '0000 0000 0000 0000'
            });
            
            // Validade
            IMask(document.getElementById('validade'), {
                mask: 'MM/YY',
                blocks: {
                    MM: {
                        mask: IMask.MaskedRange,
                        from: 1,
                        to: 12
                    },
                    YY: {
                        mask: IMask.MaskedRange,
                        from: 23,
                        to: 33
                    }
                }
            });
            
            // CVV
            IMask(document.getElementById('cvv'), {
                mask: '000'
            });
        }
        
        // Data mínima para visita (amanhã)
        const dataVisita = document.getElementById('data_visita');
        const amanha = new Date();
        amanha.setDate(amanha.getDate() + 1);
        const dataMinima = amanha.toISOString().split('T')[0];
        dataVisita.min = dataMinima;
        
        // Data máxima (6 meses à frente)
        const seisMeses = new Date();
        seisMeses.setMonth(seisMeses.getMonth() + 6);
        const dataMaxima = seisMeses.toISOString().split('T')[0];
        dataVisita.max = dataMaxima;
    });
</script>
{% endblock %}